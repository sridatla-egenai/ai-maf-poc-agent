name: $(Date:yyyyMMdd)$(Rev:.r)-agent

trigger:
  branches:
    include:
      - main
  paths:
    include:
      - agents/**
      - scripts/**
      - pipelines/agent-pipeline.yml
    exclude:
      - infrastructure/**

# Runtime Parameters
parameters:
  - name: agentFile
    displayName: 'Agent to Deploy'
    type: string
    default: 'weather-agent.yaml'
    values:
      - weather-agent.yaml

variables:
  - name: AZURE_SERVICE_CONNECTION
    value: 'ado-service-connection'
  - name: FOUNDRY_ENDPOINT
    value: 'https://adusa-poc-agent.services.ai.azure.com/api/projects/adusa-poc-agent'

pool:
  name: 'egen-agent-pool'

steps:
  - checkout: self
  
  - bash: |
      echo "ðŸ¤– Deploying Agent"
      echo "ðŸ“„ Selected Agent: ${{ parameters.agentFile }}"
      echo "ðŸ”— Endpoint: $(FOUNDRY_ENDPOINT)"
    displayName: 'Show deployment info'
  
  - task: AzureCLI@2
    displayName: 'Deploy agent with tools'
    inputs:
      azureSubscription: '$(AZURE_SERVICE_CONNECTION)'
      scriptType: bash
      scriptLocation: inlineScript
      inlineScript: |
        # Setup Python environment
        python3 -m venv .venv
        source .venv/bin/activate
        pip install -q --upgrade pip
        pip install -q -r requirements.txt
        
        # Deploy agent (uses DefaultAzureCredential with AzureCLI context)
        .venv/bin/python -m scripts.deploy_agent "$(FOUNDRY_ENDPOINT)" "agents/${{ parameters.agentFile }}"
