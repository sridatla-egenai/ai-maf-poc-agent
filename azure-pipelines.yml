trigger:
  branches:
    include:
      - main

variables:
  # Configure these as pipeline variables or in a Variable Group in Azure DevOps
  - name: AGENT_YAML_PATH
    value: 'agents/agent.yaml'
  - name: FOUNDRY_ENDPOINT
    value: 'https://adusa-poc-agent.services.ai.azure.com/api/projects/adusa-poc-agent'
  - name: AZURE_SERVICE_CONNECTION
    value: 'Azure-Subscription'

stages:

- stage: Validate
  displayName: Validate and publish agent
  jobs:
  - job: PublishAgent
    pool: 'egen-agent-pool'
    steps:
    - checkout: self
    - script: |
        mkdir -p /azp/_work/_tool
        ln -s /azp/_work/_tool /opt/hostedtoolcache
      displayName: "Symlink Python Tools Directory to Agent Tools Directory"
    - task: UsePythonVersion@0
      displayName: "install Python 3.11"
      inputs:
        versionSpec: 3.11
    

    - bash: |
        pip install -r requirements.txt
      displayName: 'Install Python dependencies from requirements.txt'
    
    - bash: |
        set -euo pipefail
        
        echo "=========================================="
        echo "Deploying agent to Azure AI Foundry"
        echo "=========================================="
        
        # Run the external deployment script
        python scripts/deploy_agent.py \
          "$(FOUNDRY_ENDPOINT)" \
          "$(AGENT_YAML_PATH)"
        
        echo ""
        echo "Agent deployment completed successfully"
      displayName: 'Deploy agent to Foundry'
      env:
        AZURE_SUBSCRIPTION_ID: $(System.AccessToken)
