trigger:
  branches:
    include:
      - main
  paths:
    include:
      - agents/**
      - infrastructure/**
      - scripts/**

variables:
  - name: FOUNDRY_ENDPOINT
    value: 'https://adusa-poc-agent.services.ai.azure.com/api/projects/adusa-poc-agent'
  - name: AZURE_SERVICE_CONNECTION
    value: 'ado-service-connection'
  - name: BICEPPARAM_FILE
    value: 'infrastructure/nonprod.bicepparam'
  - name: AGENT_YAML_PATH
    value: 'agents/weather-agent.yaml'

pool:
  name: 'egen-agent-pool'

stages:
- stage: DeployInfrastructure
  displayName: 'Deploy Infrastructure (Connections)'
  jobs:
  - job: DeployConnection
    displayName: 'Deploy weathertool connection'
    steps:
    - checkout: self
    
    - task: AzureCLI@2
      displayName: 'Deploy connection via Bicep'
      inputs:
        azureSubscription: '$(AZURE_SERVICE_CONNECTION)'
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          echo "ðŸ”— Deploying weathertool connection"
          echo "ðŸ“„ Using: $(BICEPPARAM_FILE)"
          
          # Setup Python environment
          python3 -m venv .venv
          source .venv/bin/activate
          pip install -q pyyaml
          
          # Deploy connection
          python scripts/deploy_infrastructure.py foundry_connection --bicepparam $(BICEPPARAM_FILE)

- stage: DeployAgent
  displayName: 'Deploy Agent'
  dependsOn: DeployInfrastructure
  condition: succeeded()
  jobs:
  - job: DeployWeatherAgent
    displayName: 'Deploy weather-agent'
    steps:
    - checkout: self
    
    - task: AzureCLI@2
      displayName: 'Deploy agent with tools'
      inputs:
        azureSubscription: '$(AZURE_SERVICE_CONNECTION)'
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          echo "ðŸ¤– Deploying weather-agent"
          echo "ðŸ“„ Agent: $(AGENT_YAML_PATH)"
          echo "ðŸ”— Endpoint: $(FOUNDRY_ENDPOINT)"
          
          # Setup Python environment
          python3 -m venv .venv
          source .venv/bin/activate
          pip install -q --upgrade pip
          pip install -q -r requirements.txt
          
          # Deploy agent (uses DefaultAzureCredential with AzureCLI context)
          .venv/bin/python -m scripts.deploy_agent "$(FOUNDRY_ENDPOINT)" "$(AGENT_YAML_PATH)"
