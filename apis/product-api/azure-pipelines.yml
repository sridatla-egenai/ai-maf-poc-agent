trigger: none

parameters:
  - name: azureServiceConnection
    displayName: 'Azure Subscription Service Connection'
    type: string
    default: 'ado-service-connection'
  - name: acrName
    displayName: 'Azure Container Registry Name (without .azurecr.io)'
    type: string
    default: 'myacr'
  - name: buildContext
    displayName: 'Build Context (Directory)'
    type: string
    default: 'ai-maf-poc-agent/apis/product-api'
  - name: dockerfilePath
    displayName: 'Path to Dockerfile (relative to Build Context)'
    type: string
    default: 'Dockerfile'
  - name: imageName
    displayName: 'Image Repository Name'
    type: string
    default: 'product-api'

variables:
  # Auto-incrementing version based on Build ID
  tag: '$(Build.BuildId)'

pool:
  name: 'egen-agent-pool'

steps:
- task: AzureCLI@2
  displayName: 'Login to ACR and Build/Push'
  inputs:
    azureSubscription: ${{ parameters.azureServiceConnection }}
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
      set -e
      
      # Change to build context
      echo "Changing directory to ${{ parameters.buildContext }}..."
      cd ${{ parameters.buildContext }}

      # Use ACR Build (runs in the cloud, does not require Docker on the agent)
      echo "Building and Pushing to ACR: ${{ parameters.acrName }}..."
      
      az acr build \
        --registry ${{ parameters.acrName }} \
        --image ${{ parameters.imageName }}:$(tag) \
        --image ${{ parameters.imageName }}:latest \
        --file ${{ parameters.dockerfilePath }} \
        .
